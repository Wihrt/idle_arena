name: Idle Arena CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_USER: megalooo

jobs:

  docker-bot:
    name: "Build and Push Docker bot image"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Docker login
      run: docker login -u ${{ env.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Build the Docker image
      env:
        IMAGE: arena_bot
        CONTEXT: ./golang
        GOBINARY: arenaBot
        GOFILE: ./bot/bot.go
      run: |-
        echo docker build --build-arg GOBINARY=${{ env.GOBINARY }} --build-arg GOFILE=${{ env.GOFILE }} -t ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }} ${{ env.CONTEXT }}
        docker build --build-arg GOBINARY=${{ env.GOBINARY }} --build-arg GOFILE=${{ env.GOFILE }} -t ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }} ${{ env.CONTEXT }}
        docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }}

  docker-backend:
    name: "Build and Push Docker backend image"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Docker login
      run: docker login -u ${{ env.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Build the Docker image
      env:
        IMAGE: arena_backend
        CONTEXT: ./golang
        GOBINARY: arenaBackend
        GOFILE: ./backend/backend.go
      run: |-
        echo docker build --build-arg GOBINARY=${{ env.GOBINARY }} --build-arg GOFILE=${{ env.GOFILE }} -t ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }} ${{ env.CONTEXT }}
        docker build --build-arg GOBINARY=${{ env.GOBINARY }} --build-arg GOFILE=${{ env.GOFILE }} -t ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }} ${{ env.CONTEXT }}
        docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE }}:${{ github.sha }}

  ansible:
    name: "Prepare environment and deploy"
    runs-on: ubuntu-latest
    needs:
      - docker-bot
      - docker-backend
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Install Ansible
      run: pip install ansible
    - name: Add key to playbook repository
      run: echo {{ secrets.SSH_KEY }} > ansible/vps_key_private
    - name: Run ansible playbook
      run: ansible-playbook -e "token={{ secrets.BOT_TOKEN }}" -e "target={{ secrets.TARGET_HOST }}" -e "target_user={{ secrets.TARGET_USER }}" -e "bot_version={{ github.sha }}" playbook.yml
