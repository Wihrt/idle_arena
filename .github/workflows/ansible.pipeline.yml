name: "Build Ansible image"

on:
  workflow_run:
    workflows: ["Build Docker images"]
    branches: ["main", "develop"]
    types:
    - completed


env:
  DOCKER_USER: megalooo
  ANSIBLE_VERSION: "4.3.0"

jobs:
  docker:
    name: "Pull or build Ansible docker image"
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Docker login
      run: docker login -u ${{ env.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Build Ansible Docker image
      run: |-
        docker pull ${{ env.DOCKER_USER }}/ansible:${{ env.ANSIBLE_VERSION }} || 
        (cd ansible &&
        docker build --build-arg ANSIBLE_VERSION=${{ env.ANSIBLE_VERSION }} -t ${{ env.DOCKER_USER }}/ansible:${{ env.ANSIBLE_VERSION }} . && 
        docker push ${{ env.DOCKER_USER }}/ansible:${{ env.ANSIBLE_VERSION }})